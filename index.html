<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมบันทึกข้อมูลคราบสีฟัน (Offline Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .tooth {
            width: 50px;
            height: 70px;
            border: 2px solid #6b7280;
            border-radius: 10px 10px 5px 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            position: relative;
            background-color: #f3f4f6;
        }
        .tooth .cervical-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30%;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            transition: background-color 0.2s ease-in-out;
        }
        .tooth.status-0 .cervical-area { background-color: transparent; } /* Clean */
        .tooth.status-1 .cervical-area { background-color: #ef4444; } /* Stained */

        .tooth-label {
            position: absolute;
            bottom: 5px;
            font-size: 0.8rem;
            color: #374151;
        }
        .arch-container {
            display: flex;
            justify-content: center;
            gap: 5px;
            padding: 10px;
        }
        .quadrant {
             display: flex;
             gap: 5px;
        }
        .upper-arch .quadrant:first-child, .lower-arch .quadrant:first-child {
            border-right: 2px dashed #9ca3af;
            padding-right: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600">โปรแกรมบันทึกข้อมูลคราบสีฟัน (Offline)</h1>
            <p class="text-lg text-gray-600 mt-2">ข้อมูลจะถูกบันทึกในเครื่อง และไม่หายเมื่อรีเฟรช</p>
        </header>

        <!-- Data Entry Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div id="alert-box" class="hidden p-4 mb-4 text-sm text-green-800 rounded-lg bg-green-50" role="alert"></div>

            <form id="data-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="dentist-select" class="block mb-2 text-sm font-medium text-gray-900">ผู้บันทึกข้อมูล (ทันตแพทย์)</label>
                    <select id="dentist-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-900">รายชื่อนักเรียน</label>
                    <div class="flex items-center gap-2">
                        <select id="child-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                             <option value="">-- กรุณาเพิ่มนักเรียน --</option>
                        </select>
                        <button type="button" id="select-child-btn" class="p-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </form>

            <div class="flex justify-center items-center gap-6 my-6 p-2 bg-gray-50 rounded-md">
                <h3 class="font-semibold">วิธีบันทึก:</h3>
                <span class="text-sm">คลิกเฉพาะซี่ที่ติดสี (ค่าเริ่มต้นคือสะอาด)</span>
                <div class="flex items-center gap-2"><div class="w-5 h-5 bg-red-500 rounded"></div><span>ติดสี (Stained)</span></div>
                <div class="flex items-center gap-2"><div class="w-5 h-5 bg-gray-200 border rounded"></div><span>สะอาด (Clean)</span></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-4">
                <div>
                    <h2 class="text-xl font-bold text-center mb-4 text-red-600">ก่อนการสอนแปรงฟัน</h2>
                    <div id="teeth-container-before"></div>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-center mb-4 text-green-600">หลังการสอนแปรงฟัน</h2>
                    <div id="teeth-container-after"></div>
                </div>
            </div>

            <div class="mt-8">
                 <label for="notes" class="block mb-2 text-sm font-medium text-gray-900">หมายเหตุเพิ่มเติม</label>
                 <textarea id="notes" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <div class="mt-6 text-center">
                <button type="button" id="save-btn" class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-lg px-8 py-3">
                    บันทึกข้อมูล
                </button>
            </div>
        </div>

        <!-- Data Tables & Export -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">ข้อมูลที่บันทึกไว้ทั้งหมด</h2>
                <div class="flex gap-4">
                    <button id="export-raw-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow">
                        Export Raw Data (CSV)
                    </button>
                    <button id="export-summary-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow">
                        Export Plaque % Summary (CSV)
                    </button>
                </div>
            </div>
            
            <h3 class="text-xl font-semibold mt-6 mb-2">ตารางข้อมูลดิบ (Raw Data)</h3>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                        <tr><th scope="col" class="px-6 py-3">ทันตแพทย์</th><th scope="col" class="px-6 py-3">ชื่อนักเรียน</th><th scope="col" class="px-6 py-3">ซี่ฟัน (FDI)</th><th scope="col" class="px-6 py-3">สถานะ (ก่อน)</th><th scope="col" class="px-6 py-3">สถานะ (หลัง)</th><th scope="col" class="px-6 py-3">วันที่บันทึก</th><th scope="col" class="px-6 py-3">หมายเหตุ</th></tr>
                    </thead>
                    <tbody id="data-table-body"></tbody>
                </table>
            </div>

             <h3 class="text-xl font-semibold mt-8 mb-2">ตารางสรุปเปอร์เซ็นต์คราบพลัค (Plaque % Summary)</h3>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                        <tr><th scope="col" class="px-6 py-3">ชื่อนักเรียน</th><th scope="col" class="px-6 py-3">Plaque % (ก่อน)</th><th scope="col" class="px-6 py-3">Plaque % (หลัง)</th><th scope="col" class="px-6 py-3">ผู้บันทึกล่าสุด</th></tr>
                    </thead>
                    <tbody id="summary-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Child Selection Modal -->
    <div id="child-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">เลือกรายชื่อนักเรียน</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div id="child-list-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-[70vh] overflow-y-auto">
                <!-- Child names will be populated here by JS -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const masterChildrenList = [
                'ออโต้', 'ติวเตอร์', 'เอเต้', 'ข้าวตูร์', 'นินิว', 'วีซ่า', 'โอลิฟ', 'อัญชัน', 'มายเดียร์', 'การ์ตูน', 'ปริม', 'กร', 'มาโปรด',
                'เคนโด้', 'ต้นหนาว', 'สงกรานต์', 'มีดี', 'พั้นซ์ชี่', 'ไพลิน', 'พราว', 'แพร', 'มะปราง', 'นัชชา', 'เบิร์ดเดย์',
                'จีฟอร์ซ', 'เตวิน', 'ภีม', 'ลอตเต้', 'นาย', 'สเกล', 'ฟ้าใส', 'ยูซอน', 'อลิซ', 'ต้นหลิว', 'นิวเยียร์', 'ยนิล', 'เติมเต็ม',
                'เฟสบุ๊ค', 'จอมขวัญ', 'อาร์ตี้', 'เกล', 'เคท', 'เปอร์โย', 'เจ้านาย', 'ลดา', 'แมมมอส', 'เหมยเหมย', 'ปอย', 'ไอซ์', 'ยี่หวา'
            ];
            const dentistNames = ['พู', 'เปาซ่า', 'จอย', 'นาว', 'กริ้นนี้', 'โอเปิว'];
            const anteriorTeethList = ['13', '12', '11', '21', '22', '23', '43', '42', '41', '31', '32', '33'];
            const totalSurfaces = anteriorTeethList.length;

            // --- UI ELEMENTS ---
            const dentistSelect = document.getElementById('dentist-select');
            const childSelect = document.getElementById('child-select');
            const selectChildBtn = document.getElementById('select-child-btn');
            const childModal = document.getElementById('child-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const childListContainer = document.getElementById('child-list-container');
            const beforeContainer = document.getElementById('teeth-container-before');
            const afterContainer = document.getElementById('teeth-container-after');
            const saveBtn = document.getElementById('save-btn');
            const exportRawBtn = document.getElementById('export-raw-btn');
            const exportSummaryBtn = document.getElementById('export-summary-btn');
            const rawTableBody = document.getElementById('data-table-body');
            const summaryTableBody = document.getElementById('summary-table-body');
            const notesInput = document.getElementById('notes');
            const alertBox = document.getElementById('alert-box');

            // --- LOCAL FUNCTIONS ---
            const showAlert = (message) => {
                alertBox.textContent = message;
                alertBox.classList.remove('hidden');
                setTimeout(() => alertBox.classList.add('hidden'), 3000);
            };

            const populateSelect = (selectElement, options) => {
                selectElement.innerHTML = ''; // Clear existing options
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
            };

            // --- LOCAL STORAGE & DATA HANDLING ---
            let allRecords = JSON.parse(localStorage.getItem('dentalAllRecords')) || [];
            let currentFormData = JSON.parse(localStorage.getItem('dentalCurrentForm')) || {};
            let selectedChildrenList = JSON.parse(localStorage.getItem('dentalSelectedChildren')) || [];

            const saveCurrentFormState = () => {
                currentFormData.dentist = dentistSelect.value;
                currentFormData.notes = notesInput.value;
                currentFormData.child = childSelect.value;
                localStorage.setItem('dentalCurrentForm', JSON.stringify(currentFormData));
            };

            const createTooth = (toothNum, prefix) => {
                const toothDiv = document.createElement('div');
                toothDiv.className = 'tooth';
                toothDiv.dataset.toothNum = toothNum;
                
                const cervicalArea = document.createElement('div');
                cervicalArea.className = 'cervical-area';
                const toothLabel = document.createElement('span');
                toothLabel.className = 'tooth-label';
                toothLabel.textContent = toothNum;

                toothDiv.appendChild(cervicalArea);
                toothDiv.appendChild(toothLabel);

                if (!currentFormData[prefix]) currentFormData[prefix] = {};
                currentFormData[prefix][toothNum] = currentFormData[prefix][toothNum] || 0;
                toothDiv.classList.add(`status-${currentFormData[prefix][toothNum]}`);

                toothDiv.addEventListener('click', () => {
                    let currentState = currentFormData[prefix][toothNum];
                    currentState = 1 - currentState; 
                    currentFormData[prefix][toothNum] = currentState;
                    
                    toothDiv.classList.remove('status-0', 'status-1');
                    toothDiv.classList.add(`status-${currentState}`);
                    saveCurrentFormState();
                });
                return toothDiv;
            };

            const createTeethUI = (container, prefix) => {
                container.innerHTML = '';
                const upperArch = document.createElement('div');
                upperArch.className = 'arch-container upper-arch mb-4';
                const lowerArch = document.createElement('div');
                lowerArch.className = 'arch-container lower-arch';
                
                const quadrants = {
                    upperRight: ['13', '12', '11'], upperLeft: ['21', '22', '23'],
                    lowerRight: ['43', '42', '41'], lowerLeft: ['31', '32', '33']
                };

                const upperRightDiv = document.createElement('div'); upperRightDiv.className = 'quadrant';
                quadrants.upperRight.forEach(t => upperRightDiv.appendChild(createTooth(t, prefix)));
                
                const upperLeftDiv = document.createElement('div'); upperLeftDiv.className = 'quadrant';
                quadrants.upperLeft.forEach(t => upperLeftDiv.appendChild(createTooth(t, prefix)));

                const lowerRightDiv = document.createElement('div'); lowerRightDiv.className = 'quadrant';
                quadrants.lowerRight.forEach(t => lowerRightDiv.appendChild(createTooth(t, prefix)));

                const lowerLeftDiv = document.createElement('div'); lowerLeftDiv.className = 'quadrant';
                quadrants.lowerLeft.forEach(t => lowerLeftDiv.appendChild(createTooth(t, prefix)));

                upperArch.appendChild(upperRightDiv);
                upperArch.appendChild(upperLeftDiv);
                lowerArch.appendChild(lowerRightDiv);
                lowerArch.appendChild(lowerLeftDiv);

                container.appendChild(upperArch);
                container.appendChild(lowerArch);
            };

            const renderTables = () => {
                rawTableBody.innerHTML = '';
                const statusMap = { 0: '<span class="text-green-600 font-semibold">สะอาด</span>', 1: '<span class="text-red-600 font-semibold">ติดสี</span>' };
                allRecords.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `<td class="px-6 py-4">${record.dentist}</td><td class="px-6 py-4">${record.child}</td><td class="px-6 py-4">${record.toothNum}</td><td class="px-6 py-4">${statusMap[record.beforeStatus]}</td><td class="px-6 py-4">${statusMap[record.afterStatus]}</td><td class="px-6 py-4">${record.date}</td><td class="px-6 py-4">${record.notes}</td>`;
                    rawTableBody.appendChild(row);
                });

                const summaryData = {};
                const recordsByChild = allRecords.reduce((acc, rec) => {
                    acc[rec.child] = acc[rec.child] || [];
                    acc[rec.child].push(rec);
                    return acc;
                }, {});

                Object.keys(recordsByChild).forEach(childName => {
                    const childRecords = recordsByChild[childName];
                    const latestRecord = childRecords[childRecords.length - 1];
                    summaryData[childName] = { dentist: latestRecord.dentist, beforeStained: 0, afterStained: 0 };
                    const latestToothRecords = {};
                    childRecords.forEach(rec => { latestToothRecords[rec.toothNum] = rec; });
                    Object.values(latestToothRecords).forEach(rec => {
                         if (rec.beforeStatus === 1) summaryData[childName].beforeStained++;
                         if (rec.afterStatus === 1) summaryData[childName].afterStained++;
                    });
                });
                
                summaryTableBody.innerHTML = '';
                Object.keys(summaryData).sort().forEach(childName => {
                    const data = summaryData[childName];
                    const beforePercent = ((data.beforeStained / totalSurfaces) * 100).toFixed(2);
                    const afterPercent = ((data.afterStained / totalSurfaces) * 100).toFixed(2);
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `<td class="px-6 py-4 font-medium text-gray-900">${childName}</td><td class="px-6 py-4">${beforePercent}%</td><td class="px-6 py-4">${afterPercent}%</td><td class="px-6 py-4">${data.dentist}</td>`;
                    summaryTableBody.appendChild(row);
                });
            };

            const saveRecord = () => {
                const child = childSelect.value;
                if (!child) {
                    showAlert("กรุณาเพิ่มและเลือกนักเรียนก่อนบันทึก");
                    return;
                }
                const dentist = dentistSelect.value;
                const notes = notesInput.value;
                const recordDate = new Date().toLocaleDateString('th-TH');

                allRecords = allRecords.filter(rec => rec.child !== child);

                anteriorTeethList.forEach(toothNum => {
                    const beforeStatus = currentFormData.before[toothNum] || 0;
                    const afterStatus = currentFormData.after[toothNum] || 0;
                    allRecords.push({ dentist, child, toothNum, beforeStatus, afterStatus, date: recordDate, notes });
                });

                localStorage.setItem('dentalAllRecords', JSON.stringify(allRecords));
                localStorage.removeItem('dentalCurrentForm');
                currentFormData = {};
                
                showAlert("บันทึกข้อมูลสำหรับ '" + child + "' สำเร็จ!");
                loadPage();
            };
            
            const downloadCSV = (csvContent, fileName) => {
                const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const exportRawData = () => {
                if (allRecords.length === 0) { showAlert('ไม่มีข้อมูลดิบให้ export'); return; }
                const statusMap = { 0: 'Clean', 1: 'Stained' };
                const headers = ['Dentist', 'Child Name', 'Tooth Number (FDI)', 'Status Before', 'Status After', 'Record Date', 'Notes'];
                const csvRows = [headers.join(',')];
                allRecords.forEach(rec => {
                    const values = [`"${rec.dentist}"`, `"${rec.child}"`, `"${rec.toothNum}"`, `"${statusMap[rec.beforeStatus]}"`, `"${statusMap[rec.afterStatus]}"`, `"${rec.date}"`, `"${rec.notes.replace(/"/g, '""')}"`];
                    csvRows.push(values.join(','));
                });
                downloadCSV(csvRows.join('\n'), 'dental_raw_data.csv');
            };

            const exportSummaryData = () => {
                const summaryRows = Array.from(summaryTableBody.querySelectorAll('tr'));
                if (summaryRows.length === 0) { showAlert('ไม่มีข้อมูลสรุปให้ export'); return; }
                const headers = ['Child Name', 'Plaque % Before', 'Plaque % After', 'Last Recorded By'];
                const csvRows = [headers.join(',')];
                summaryRows.forEach(row => {
                    const cells = Array.from(row.querySelectorAll('td')).map(cell => `"${cell.textContent}"`);
                    csvRows.push(cells.join(','));
                });
                downloadCSV(csvRows.join('\n'), 'dental_plaque_summary.csv');
            };

            const handleChildSelectionFromModal = (selectedChild) => {
                if (!selectedChildrenList.includes(selectedChild)) {
                    selectedChildrenList.push(selectedChild);
                    localStorage.setItem('dentalSelectedChildren', JSON.stringify(selectedChildrenList));
                    
                    const opt = document.createElement('option');
                    opt.value = selectedChild;
                    opt.textContent = selectedChild;
                    childSelect.appendChild(opt);
                }
                childSelect.value = selectedChild;
                childSelect.dispatchEvent(new Event('change'));
                childModal.classList.add('hidden');
            };

            const populateChildModal = () => {
                childListContainer.innerHTML = '';
                masterChildrenList.forEach(name => {
                    const nameBtn = document.createElement('button');
                    nameBtn.type = 'button';
                    nameBtn.textContent = name;
                    nameBtn.className = 'w-full text-left p-2 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500';
                    nameBtn.addEventListener('click', () => handleChildSelectionFromModal(name));
                    childListContainer.appendChild(nameBtn);
                });
            };

            // --- PAGE INITIALIZATION ---
            const loadPage = () => {
                populateSelect(dentistSelect, dentistNames);
                populateChildModal();
                
                // Populate child dropdown from the saved list
                childSelect.innerHTML = '<option value="">-- กรุณาเพิ่มนักเรียน --</option>';
                selectedChildrenList.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    childSelect.appendChild(opt);
                });

                dentistSelect.value = currentFormData.dentist || dentistNames[0];
                childSelect.value = currentFormData.child || '';
                notesInput.value = currentFormData.notes || '';

                createTeethUI(beforeContainer, 'before');
                createTeethUI(afterContainer, 'after');
                
                renderTables();
            };

            loadPage();

            // --- EVENT LISTENERS ---
            dentistSelect.addEventListener('change', saveCurrentFormState);
            
            childSelect.addEventListener('change', (e) => {
                const selectedChild = e.target.value;
                if (!selectedChild) {
                    currentFormData = {};
                    localStorage.removeItem('dentalCurrentForm');
                    loadPage();
                    return;
                }

                const childRecords = allRecords.filter(rec => rec.child === selectedChild);

                if (childRecords.length > 0) {
                    const latestRecord = childRecords[childRecords.length - 1];
                    currentFormData = {
                        dentist: latestRecord.dentist,
                        child: selectedChild,
                        notes: latestRecord.notes,
                        before: {},
                        after: {}
                    };
                    childRecords.forEach(rec => {
                        currentFormData.before[rec.toothNum] = rec.beforeStatus;
                        currentFormData.after[rec.toothNum] = rec.afterStatus;
                    });
                } else {
                    currentFormData = {
                        dentist: dentistSelect.value,
                        child: selectedChild,
                        notes: '',
                        before: {},
                        after: {}
                    };
                }
                localStorage.setItem('dentalCurrentForm', JSON.stringify(currentFormData));
                loadPage();
            });

            notesInput.addEventListener('input', saveCurrentFormState);
            saveBtn.addEventListener('click', saveRecord);
            exportRawBtn.addEventListener('click', exportRawData);
            exportSummaryBtn.addEventListener('click', exportSummaryData);
            selectChildBtn.addEventListener('click', () => childModal.classList.remove('hidden'));
            closeModalBtn.addEventListener('click', () => childModal.classList.add('hidden'));
            childModal.addEventListener('click', (e) => {
                if (e.target.id === 'child-modal') {
                    childModal.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
